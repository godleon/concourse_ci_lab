platform: linux

image_resource:
  type: docker-image
  source:
    repository: python
    tag: "3.6"
    # repository: ubuntu
    # tag: xenial

inputs:
- name: git-osp
- name: git-semver
- name: rally_test

outputs:
- name: propagated_tests

run:
  path: sh
  args:
  - -exc
  - |
    ENTRY_PATH=$(pwd)
    RESOURCE_VER=$(cat git-semver/version)
    whoami
    env
  
    apt-get update
    apt-get -y install git python3 python3-jinja2

    git clone rally_test propagated_tests

    cd git-osp/09.rally/scripts
    mkdir -p propagated_tests
    git clone https://github.com/openstack/rally.git
    find rally/samples/tasks/scenarios/ -type f -name '*.json' | egrep 'rally/samples/tasks/scenarios/(authenticate|cinder|glance|keystone|neutron|nova|quotas|requests|swift)' > upstream_tests.list

    chmod +x propagate_test.py
    ./propagate_test.py
    cp -r propagated_tests/* ${ENTRY_PATH}/propagated_tests/
    cd ${ENTRY_PATH}/propagated_tests
    git config --global user.email "nobody@concourse.ci"
    git config --global user.name "Concourse"
    git add .
    git commit -m "Rally propagated tests - version ${RESOURCE_VER}"
    cd ..
    find .